name: Diagnose VM Network Connectivity


on:
  workflow_dispatch:

jobs:
  troubleshoot-inbound:
    runs-on: ubuntu-latest
    steps:
    
    # Step 1: Checkout repository (optional if needed for context)
    - name: Checkout repository
      uses: actions/checkout@v2

    # Step 2: Install Docker and setup the container if necessary
    - name: Set up Docker in the container
      uses: docker/setup-buildx-action@v2

    # Step 3: Verify Docker Version and Running Containers
    - name: Verify Docker Version and Running Containers
      run: |
        docker --version
        docker ps -a

    # Step 4: Inspect Docker's Network Configuration (Bridge or Host mode)
    - name: Inspect Docker's Network Configuration (Bridge or Host mode)
      run: |
        docker network ls
        docker network inspect bridge
        docker network inspect host

    # Step 5: Check Exposed Ports for Running Containers
    - name: Check Exposed Ports for Running Containers
      run: |
        docker ps --format "table {{.Names}}\t{{.Ports}}"

    # Step 6: Check iptables Rules from Inside the Container
    - name: Check iptables Rules for Inbound Traffic (inside container)
      run: |
        sudo iptables -L -v -n
        sudo iptables -t nat -L -v -n
        sudo iptables -t mangle -L -v -n
    
    # Step 7: Check Docker-Specific iptables Chains Inside Container
    - name: Check Docker-Specific iptables Chains (inside container)
      run: |
        sudo iptables -S DOCKER
        sudo iptables -S DOCKER-USER
        sudo iptables -S DOCKER-FORWARD
    
    # Step 8: Check if the Service Inside the Container is Listening
    - name: Verify Service Listening on Ports Inside Container
      run: |
        netstat -tuln
        # or
        ss -tuln

    # Step 9: Check if the Service is Bound to Correct Network Interface (0.0.0.0)
    - name: Verify Service Bound to Correct Network Interface (0.0.0.0 or Host IP)
      run: |
        ss -tuln
        # Optionally check if the service binds only to localhost (127.0.0.1)
        netstat -tuln

        
    # Step 10: Test Port Access to Container from Itself (localhost)
    - name: Test Access to Container's Exposed Port on localhost
      run: |
        # Dynamically retrieve the port number
        container_port=$(ss -tuln | grep '0.0.0.0' | grep -oP ':\K\d+')
        
        echo "Testing access to container's exposed port on localhost: $container_port"
        
        # Test with Netcat (nc)
        nc -zv 127.0.0.1 $container_port
        
        # Optionally, test with curl or telnet if nc is unavailable
        # curl http://127.0.0.1:$container_port
        # telnet 127.0.0.1 $container_port
    
    # Step 11: Test Connectivity to Exposed Port on Host Network (external access)
    - name: Test Port Connectivity to Host (External Access)
      run: |
        # Dynamically retrieve the port number
        container_port=$(ss -tuln | grep '0.0.0.0' | grep -oP ':\K\d+')
        
        # Retrieve the host IP
        host_ip=$(hostname -I | awk '{print $1}')
        
        echo "Testing external access to container's exposed port on host IP: $host_ip:$container_port"
        
        # Test with Netcat (nc)
        nc -zv $host_ip $container_port
        
        # Optionally, test with curl or telnet if nc is unavailable
        # curl http://$host_ip:$container_port
        # telnet $host_ip $container_port


