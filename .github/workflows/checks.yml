name: Diagnose VM Network Connectivity


on:
  workflow_dispatch:

jobs:
  troubleshoot-inbound:
    runs-on: ubuntu-latest
    steps:
    
    # Step 1: Checkout repository (Optional if needed for code context)
    - name: Checkout repository
      uses: actions/checkout@v2

    # Step 2: Install Docker if it's not already present
    - name: Set up Docker
      uses: docker/setup-buildx-action@v2

    # Step 3: Verify Docker is installed and check running containers
    - name: Verify Docker Installation and Running Containers
      run: |
        docker --version
        docker ps -a
    
    # Step 4: Inspect Docker's network configuration
    - name: Inspect Docker Network Configuration (Bridge, Host, etc.)
      run: |
        docker network ls
        docker network inspect bridge
        docker network inspect host
    
    # Step 5: Check exposed ports for running containers
    - name: List Exposed Ports for Running Containers
      run: |
        docker ps --format "table {{.Names}}\t{{.Ports}}"
    
    # Step 6: Inspect iptables rules for inbound traffic restrictions
    - name: Check iptables Rules for Inbound Traffic
      run: |
        sudo iptables -L -v -n
        sudo iptables -t nat -L -v -n
        sudo iptables -t mangle -L -v -n
    
    # Step 7: Inspect Docker-specific iptables chains
    - name: Check Docker's iptables Chains
      run: |
        sudo iptables -S DOCKER
        sudo iptables -S DOCKER-USER
        sudo iptables -S DOCKER-FORWARD

    # Step 8: Verify the container is listening on the expected port
    - name: Verify Service is Listening on Expected Ports Inside Container
      run: |
        # Replace <container_name_or_id> with the actual container name or ID
        docker exec <container_name_or_id> netstat -tuln
    
    # Step 9: Verify service is bound to the correct network interface (0.0.0.0 or host IP)
    - name: Check Service Binding to Network Interface (0.0.0.0 or host IP)
      run: |
        docker exec <container_name_or_id> ss -tuln
    
    # Step 10: Test Connectivity to Exposed Port on Host Network
    - name: Test Inbound Connectivity to Exposed Port on Host
      run: |
        # Replace <host_ip> and <port> with the actual host IP and port exposed by the container
        nc -zv <host_ip> <port>
        # Optional: You can also test with curl or telnet if nc is not available
        # curl http://<host_ip>:<port>
        # telnet <host_ip> <port>
    
    # Step 11: Test access to exposed port externally (from an external network)
    - name: Attempt to Access Exposed Port from External Network
      run: |
        # Replace <external_ip> with the public IP or hostname of the VM
        curl http://<external_ip>:<port>
        # Or use telnet for raw TCP connection testing
        # telnet <external_ip> <port>


