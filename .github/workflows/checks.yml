name: Diagnose and Alter Container Network Configuration

on:
  workflow_dispatch:

jobs:
  troubleshoot-network:
    runs-on: ubuntu-latest
    steps:
    
    # Step 1: Display the Container's Network Configuration
    - name: Display Network Configuration
      run: |
        echo "Displaying network configuration..."
        ip addr show
        ip route show
        
    # Step 2: Identify the Container's IP Address
    - name: Identify Container's IP Address
      run: |
        echo "Identifying container's IP address..."
        
        # Retrieve the container's IP address (eth0 typically on Docker)
        container_ip=$(hostname -I | awk '{print $1}')
        
        # Alternatively, you can use ip addr
        # container_ip=$(ip addr show eth0 | grep inet | awk '{print $2}' | cut -d/ -f1)
        
        echo "Container IP Address: $container_ip"
        
        # Export the IP address for later use in iptables rules
        echo "CONTAINER_IP=$container_ip" >> $GITHUB_ENV

    # Step 3: Display iptables Configuration before Altering
    - name: Display iptables Configuration Before Altering
      run: |
        echo "Displaying iptables rules before alteration..."
        sudo iptables -L -v -n
        sudo iptables -t nat -L -v -n

    # Step 4: Alter iptables (DNAT and Forwarding Rules)
    - name: Alter iptables to Forward Ports to Container
      run: |
        echo "Altering iptables rules to forward ports to container..."

        # Retrieve container IP from environment variable
        container_ip=$CONTAINER_IP
        
        # Allow incoming traffic on port 80 to be forwarded to the container
        sudo iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination $container_ip:80
        sudo iptables -A FORWARD -p tcp -d $container_ip --dport 80 -j ACCEPT
        
        # Allow incoming traffic on port 443 to be forwarded to the container (optional)
        sudo iptables -t nat -A PREROUTING -p tcp --dport 443 -j DNAT --to-destination $container_ip:443
        sudo iptables -A FORWARD -p tcp -d $container_ip --dport 443 -j ACCEPT

        # Display the iptables rules after alteration
        echo "Displaying iptables rules after alteration..."
        sudo iptables -L -v -n
        sudo iptables -t nat -L -v -n

    # Step 5: Confirm iptables Configuration
    - name: Confirm iptables Configuration
      run: |
        echo "Confirming iptables rules for the container..."
        sudo iptables -L -v -n
        sudo iptables -t nat -L -v -n
