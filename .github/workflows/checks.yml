name: Diagnose VM Network Connectivity


on:
  workflow_dispatch:


jobs:
  troubleshoot-inbound:
    runs-on: ubuntu-latest
    steps:
    
    # Step 1: Checkout code (if applicable, if you're testing on a VM, this is not necessary)
    - name: Checkout repository
      uses: actions/checkout@v2

    # Step 2: Install Docker
    - name: Set up Docker
      uses: docker/setup-buildx-action@v2
    
    # Step 3: Check Docker version and inspect current containers
    - name: Check Docker Version & Running Containers
      run: |
        docker --version
        docker ps -a

    # Step 4: Check the Docker network configuration (default bridge or host network)
    - name: Inspect Docker Network Configuration
      run: |
        docker network ls
        docker network inspect bridge
        docker network inspect host
    
    # Step 5: Check which ports are exposed by the container
    - name: List Exposed Ports for Docker Containers
      run: |
        docker ps --format "table {{.Names}}\t{{.Ports}}"
    
    # Step 6: Inspect Docker's iptables rules and firewall
    - name: Check Docker's iptables Rules
      run: |
        sudo iptables -L -v -n
        sudo iptables -t nat -L -v -n
        sudo iptables -t mangle -L -v -n

    # Step 7: Check for Docker-specific isolation or firewall chains
    - name: Inspect Docker Chains in iptables
      run: |
        sudo iptables -S DOCKER
        sudo iptables -S DOCKER-USER
        sudo iptables -S DOCKER-FORWARD

    # Step 8: Ensure that the container is listening on the correct port
    - name: Check if the service is listening inside the container
      run: |
        # Replace <container_id_or_name> with the actual container ID or name
        docker exec <container_id_or_name> netstat -tuln
    
    # Step 9: Check whether the container is bound to all interfaces or only localhost
    - name: Check Bound Interfaces of Service Inside Container
      run: |
        docker exec <container_id_or_name> ss -tuln

    # Step 10: Test if the container's port is reachable from outside the container
    - name: Test if Container's Port is Accessible
      run: |
        # Replace <host_ip> and <port> with your actual host and port
        nc -zv <host_ip> <port>
        # Optional: You can test with telnet or curl if nc is not available:
        # curl http://<host_ip>:<port>
        # telnet <host_ip> <port>

    # Step 11: Try connecting to container's exposed ports from the external network (If possible)
    - name: Attempt Connection to Exposed Port
      run: |
        # Replace <external_host_ip> with the actual public IP or hostname
        curl http://<external_host_ip>:<port>

