name: Diagnose VM Network Connectivity


on:
  workflow_dispatch:


jobs:
  troubleshoot-network:
    runs-on: ubuntu-latest
    steps:
    
    # Step 2: Check the VMâ€™s Network Configuration from Inside the Docker Container
    - name: Check Host (VM) Network Configuration
      run: |
        # Display VM's network interfaces and IP configuration
        ip addr show
        
        # Check routing table of the VM to see if there is any issue with routing
        ip route show
      
    # Step 3: Check if the Container Can Access the Host's External IP
    - name: Check Connectivity to Host's External IP from Inside the Container
      run: |
        # Retrieve the VM's external IP (e.g., public IP or internal network IP)
        vm_ip=$(hostname -I | awk '{print $1}')
        
        # Output the external IP for debugging purposes
        echo "VM External IP: $vm_ip"
        
        # Test connectivity from the container to the VM's external IP
        echo "Testing connectivity to host VM external IP: $vm_ip"
        
        # Attempt to connect to HTTP and HTTPS ports on the VM's external IP
        # Using nc (netcat) to test connectivity on port 80 and 443
        # The -z flag tells nc to scan for open ports without sending any data, and -v is for verbose output
        
        # Test port 80 (HTTP)
        nc -zv $vm_ip 80 || echo "Connection to $vm_ip on port 80 failed"
        
        # Test port 443 (HTTPS)
        nc -zv $vm_ip 443 || echo "Connection to $vm_ip on port 443 failed"
        
        # Additional steps could be added here for further checks or debugging
        # For example, you can use curl or telnet as an alternative


    # Step 4: Check iptables Rules (Inside Container)
    - name: Check iptables Rules (Inside Container)
      run: |
        # List the iptables rules on the host machine
        sudo iptables -L -v -n
        sudo iptables -t nat -L -v -n

    # Step 5: Test Internet Connectivity (Ping External IP)
    - name: Test Internet Connectivity (Ping External IP)
      run: |
        # Test connectivity to an external public IP (Google DNS for example)
        ping -c 4 8.8.8.8

    # Step 6: Test Internet Connectivity (HTTP/HTTPS)
    - name: Test HTTP/HTTPS Connectivity
      run: |
        # Test HTTP access to a public website (using curl)
        curl -I http://google.com
        
        # Test HTTPS access to a public website
        curl -I https://google.com

    # Step 7: Check DNS Resolution
    - name: Check DNS Resolution
      run: |
        # Check the DNS configuration of the VM
        cat /etc/resolv.conf
        
        # Test DNS resolution by pinging a known domain
        ping -c 4 google.com
        curl -I google.com

    # Step 8: Check Default Route and Outbound Connectivity
    - name: Check Default Route and Outbound Connectivity
      run: |
        # Check the default route (gateway)
        ip route show
        
        # Check if the gateway is reachable (test outbound traffic)
        gateway=$(ip route | grep default | awk '{print $3}')
        echo "Testing gateway $gateway..."
        ping -c 4 $gateway

    # Step 9: Check iptables for Outbound Traffic Rules
    - name: Check iptables for Outbound Traffic Rules
      run: |
        # List the iptables rules related to outbound traffic
        sudo iptables -L -v -n
        sudo iptables -t nat -L -v -n
        sudo iptables -t mangle -L -v -n

    # Step 10: Check NAT Configuration (Outbound Traffic Translation)
    - name: Check NAT Configuration (Outbound Traffic Translation)
      run: |
        # Check if the VM is using NAT to access the external network
        iptables -t nat -L -v -n
        # If using AWS, GCP, or similar, check if the instance is behind a NAT gateway
        # Example for AWS instances with private IPs in a VPC
        curl http://169.254.169.254/latest/meta-data/local-ipv4

    # Step 11: Test Reachability of Common External Ports (80, 443)
    - name: Test Reachability of External Ports (80, 443)
      run: |
        # Test access to public web servers on port 80 (HTTP)
        nc -zv 8.8.8.8 80
        
        # Test access to public web servers on port 443 (HTTPS)
        nc -zv 8.8.8.8 443
