name: Diagnose and Alter Container Network Configuration

on:
  workflow_dispatch:

jobs:
  troubleshoot-network:
    runs-on: ubuntu-latest
    steps:
    
    # Step 1: Display the Container's Network Configuration
    - name: Display Network Configuration
      run: |
        echo "Displaying network configuration..."
        ip addr show
        ip route show
        
    # Step 2: Identify the Container's IP Address
    - name: Identify Container's IP Address
      run: |
        echo "Identifying container's IP address..."
        
        # Retrieve the container's IP address (eth0 typically on Docker)
        container_ip=$(hostname -I | awk '{print $1}')
        
        # Optionally, use ip addr command to identify the container's IP
        # container_ip=$(ip addr show eth0 | grep inet | awk '{print $2}' | cut -d/ -f1)
        
        echo "Container IP Address: $container_ip"
        
        # Export the IP address for later use in iptables rules
        echo "CONTAINER_IP=$container_ip" >> $GITHUB_ENV

    # Step 3: Display iptables Configuration before Altering
    - name: Display iptables Configuration Before Altering
      run: |
        echo "Displaying iptables rules before alteration..."
        sudo iptables -L -v -n
        sudo iptables -t nat -L -v -n

    # Step 4: Alter iptables (DNAT and Forwarding Rules)
    - name: Alter iptables to Forward Ports to Container
      run: |
        echo "Altering iptables rules to forward ports to container..."

        # Retrieve container IP from environment variable
        container_ip=$CONTAINER_IP
        
        # Allow incoming traffic on port 8080 to be forwarded to the container
        sudo iptables -t nat -A PREROUTING -p tcp --dport 8080 -j DNAT --to-destination $container_ip:80
        sudo iptables -A FORWARD -p tcp -d $container_ip --dport 8080 -j ACCEPT
        
        # Allow incoming traffic on port 443 to be forwarded to the container (optional)
        sudo iptables -t nat -A PREROUTING -p tcp --dport 443 -j DNAT --to-destination $container_ip:443
        sudo iptables -A FORWARD -p tcp -d $container_ip --dport 443 -j ACCEPT
      
        # Display the iptables rules after alteration
        echo "Displaying iptables rules after alteration..."
        sudo iptables -L -v -n
        sudo iptables -t nat -L -v -n
        
        # Allow firewall to accept traffic on the altered ports (80 and 443)
        sudo ufw allow 80/tcp
        sudo ufw allow 443/tcp

    # Step 5: Confirm iptables Configuration
    - name: Confirm iptables Configuration
      run: |
        echo "Confirming iptables rules for the container..."
        sudo iptables -L -v -n
        sudo iptables -t nat -L -v -n

    # Step 6: Start HTTP Server on Port 8080 with Elevated Privileges and Keep Container Alive
    - name: Start HTTP Server on Port 8080 with Elevated Privileges
      run: |
        public_ip=$(curl -s http://checkip.amazonaws.com)
        echo "Public IP: $public_ip"
        
        # Start the HTTP server with sudo to allow binding to port 8080
        sudo python3 -m http.server 8080 &
        
        # Keep the container alive with an infinite loop
        while true; do 
          # Get the public IP of the host/container's external IP
          public_ip=$(curl -s http://checkip.amazonaws.com)
          echo "Public IP: $public_ip"
          
          # Attempt to curl the container's own public IP at port 8080
          curl http://$public_ip:8080 && echo "Successfully reached the container on port 8080" || echo "Failed to reach container on port 8080"
          
          sleep 5
        done
